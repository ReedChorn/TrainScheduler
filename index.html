<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="css/reset.css"> -->
    <link rel="stylesheet" type="text/javascript" href="css/javascript.js">
    <title>Train Tracker</title>
</head>
<body>
    
<!-- HTML ELEMENTS -->

<div class="container">
    <div class="jumbotron text-center" id="jumbotron">
        <h1 align= center >Train Scheduler</h1>
        <p align= center >Find train travel info here</p>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading"><b>Current Train Schedule</b></div><br>
        <div class="panel-body">
            <table align= center class="table">
                <thead>
                    <tr>
                        <th>Train Name</th>
                        <th>Destination</th>
                        <th>Frequency</th>
                        <th>Next Arrival</th>
                        <th>Minutes Away</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading"><b>Add Train</b></div><br>
        <div class="panel-body">
            <div class="form-group">
                <label for="trainName">Train Name</label><br>
                <input align= center type="text" class="form-control" id="trainName"><br>

                <label for="destination">Destination</label><br>
                <input align= center type="text" class="form-control" id="destination"><br>

                <label for="firstTrainTime">First Train Time (HH:mm)</label><br>
                <input align= center type="time" class="form-control" id="firstTrainTime"><br>

                <label for="frequency">Frequency (min)</label><br>
                <input align= center type="time" class="form-control" id="frequency"><br>
                <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<!-- HTML ELEMENTS END -->


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>

<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>

 <!-- MomentJS -->
<script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBzjVg4xIUIiv25Kxd4i2SQXQlKW8Ukw-0",
    authDomain: "employeedatabase-7eb23.firebaseapp.com",
    databaseURL: "https://employeedatabase-7eb23.firebaseio.com",
    projectId: "employeedatabase-7eb23",
    storageBucket: "",
    messagingSenderId: "59311237449"
  };
  firebase.initializeApp(config);

// 2. Populate Firebase Database with initial data (in this case, I did this via Firebase GUI)
  var database = firebase.database()
  var users = database.ref('/users')

// 3. Button for adding trains
$(document).on('click', '#submitBtn', function() {

    var trainName = $('#trainName').val().trim()
    var destination = $('#destination').val().trim()
    var firstTrainTime = moment($('#firstTrainTime').val().trim(), 'HH:mm').format('HH:mm')
    var frequency = parseInt($('#frequency').val().trim())

	// Creates local "temporary" object for holding train data
	var newTrain = {
	  trainName : trainName,
      destination : destination,
      frequency : frequency,
      firstTrainTime : firstTrainTime
	}

	// Uploads train data to the database
	users.push(newTrain);

	// Logs everything to console
	console.log(newTrain.trainName);
	console.log(newTrain.destination); 
	console.log(firstTrainTime);
	console.log(newTrain.frequency)

	// Alert
	alert("Train successfully added");

	// Clears all of the text-boxes
	$("#trainNameInput").val("");
	$("#destinationInput").val("");
	$("#firstTrainTimeInput").val("");
	$("#frequencyInput").val("");

	// Determine when the next train arrives.
	return false;
});

// 4. Create Firebase event for adding trains to the database and a row in the html when a user adds an entry
users.on("child_added", function(childSnapshot, prevChildKey){

	console.log(childSnapshot.val());

	// Store everything into a variable.
	var tName = childSnapshot.val().trainName;
	var tDestination = childSnapshot.val().destination;
	var tFrequency = childSnapshot.val().frequency;
	var tFirstTrain = childSnapshot.val().firstTrainTime;

	// Calculate the minutes until arrival using hardcore math
	// To calculate the minutes till arrival, take the current time in unix subtract the FirstTrain time and find the modulus between the difference and the frequency  
	var differenceTimes = moment().diff(moment.unix(tFirstTrain), "minutes");
	var tRemainder = moment().diff(moment.unix(tFirstTrain), "minutes") % tFrequency ;
	var tMinutes = tFrequency - tRemainder;

	// To calculate the arrival time, add the tMinutes to the currrent time
	var tArrival = moment().add(tMinutes, "m").format("hh:mm A"); 
	console.log(tMinutes);
	console.log(tArrival);

	console.log(moment().format("hh:mm A"));
	console.log(tArrival);
	console.log(moment().format("X"));

    // Add each train's data into the table 
    function appendTrain(train) {
    var addTrain = '<tr>' +
        '<td>' + train.trainName + '</td>' +
        '<td>' + train.destination + '</td>' + 
        '<td>' + train.frequency + '</td>' + 
        '<td>' + nextArrival + '</td>' + 
        '<td>' + minutes + '</td>' + 
      '</tr>'
    
    // append info
    $('tbody').append(addTrain)
  } 
	

});

//   var database = firebase.database()
//   var users = database.ref('/users')
  
//   // this will basically append all the necessary information to the "tbody" element on the table
//   function appendTrain(train) {
//     var addTrain = '<tr>' +
//         '<td>' + train.trainName + '</td>' +
//         '<td>' + train.destination + '</td>' + 
//         '<td>' + train.frequency + '</td>' + 
//         '<td>' + nextArrival + '</td>' + 
//         '<td>' + minutes + '</td>' + 
//       '</tr>'
    
//     // append info
//     $('tbody').append(addTrain)
//   } 
//     var diffTime = moment().diff(moment.unix(firstTrainTime), "minutes");
// 	var timeRemainder = moment().diff(moment.unix(firstTrainTime), "minutes") % frequency ;
// 	var minutes = frequency - timeRemainder;
//     var nextArrival = moment().add(minutes, "m").format("hh:mm A"); 

//   // On click of the Submit Button, store/push all info to the database
//   $(document).on('click', '#submitBtn', function() {
//     var trainName = $('#trainName').val().trim()
//     var destination = $('#destination').val().trim()
//     var firstTrainTime = moment($('#firstTrainTime').val().trim(), 'HH:mm').format('HH:mm')
//     var frequency = parseInt($('#frequency').val().trim())
    
//     users.push({
//       trainName : trainName,
//       destination : destination,
//       frequency : frequency,
//       firstTrainTime : firstTrainTime
//     })  
// })

// // When child is added to database, take the last/most recent child and call appendTrain() to add it to table
// users.limitToLast(1).on('child_added', function(snap) {
//   appendTrain(snap.val())

// })

// console.log(moment().minutes())

// </script>
</body>
</html>
